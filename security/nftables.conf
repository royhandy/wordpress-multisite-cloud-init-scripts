#!/usr/sbin/nft -f
flush ruleset

table inet filter {

  set cf4 {
    type ipv4_addr
    flags interval
    auto-merge
  }

  set cf6 {
    type ipv6_addr
    flags interval
    auto-merge
  }

  chain input {
    type filter hook input priority 0;
    policy drop;

    # Loopback
    iif lo accept

    # Established connections
    ct state established,related accept

    # ICMP (health + MTU)
    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    # HTTPS from Cloudflare only
    tcp dport 443 ip  saddr @cf4 accept
    tcp dport 443 ip6 saddr @cf6 accept
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;
  }

  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}
