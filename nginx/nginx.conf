user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections 1024;
  multi_accept on;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  server_tokens off;

  ##
  # PHP-FPM upstream
  ##
  upstream php_fpm {
    server unix:/run/php/server-fpm.sock;
  }

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  keepalive_timeout 30;
  client_body_timeout 30;
  client_header_timeout 30;
  send_timeout 30;

  types_hash_max_size 2048;

  ##
  # Logging (disk-conscious)
  ##
  log_format cf_main '$remote_addr - $host [$time_local] '
                     '"$request" $status $body_bytes_sent '
                     '"$http_referer" "$http_user_agent" '
                     'cf="$http_cf_ray"';

  # Only log wp-login, wp-admin, errors
  map $request_uri $log_uri {
    default 0;
    ~*^/wp-login\.php$ 1;
    ~*^/wp-admin/ 1;
    ~*^/xmlrpc\.php$ 1;
  }

  map $status $log_status {
    default 0;
    ~^[45] 1;
  }

  map "$log_uri$log_status" $should_log {
    default 0;
    "10" 1;
    "01" 1;
    "11" 1;
  }

  access_log /var/log/nginx/access.log cf_main if=$should_log;
  error_log  /var/log/nginx/error.log warn;

  ##
  # TLS (origin only)
  ##
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets off;

  ##
  # Rate limiting (real IP after CF realip include)
  ##
  limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=10r/s;

  ##
  # Includes
  ##
  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-enabled/*;
}
